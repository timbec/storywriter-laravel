name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: prod-deployment
  cancel-in-progress: false

env:
  APP_DIR: /var/www/storywriter-prod

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: curl, mbstring, xml, zip, pgsql, bcmath, intl
          coverage: none

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

      - name: Install NPM dependencies
        run: npm ci

      - name: Build frontend assets
        run: npm run build

      - name: Create deployment artifact
        run: |
          mkdir -p artifact

          # Copy application files
          rsync -av --exclude='artifact' \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='tests' \
            --exclude='.env' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            . artifact/

          # Create tarball with commit info in filename
          tar -czf deployment-${{ github.sha }}.tar.gz -C artifact .

          # Create a symlink for easy reference
          ln -s deployment-${{ github.sha }}.tar.gz deployment-latest.tar.gz

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifact
          path: deployment-${{ github.sha }}.tar.gz
          retention-days: 7

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifact

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup and prepare deployment
        run: |
          ssh -i ~/.ssh/deploy_key deploy@${{ secrets.PRODUCTION_HOST }} << 'PREPARE_SCRIPT'
            set -e

            APP_DIR=/var/www/storywriter-prod

            # Create releases directory if it doesn't exist
            mkdir -p /var/www/releases

            # Create timestamped backup of current release
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="/var/www/releases/backup_${TIMESTAMP}"

            if [ -d "$APP_DIR" ] && [ "$(ls -A $APP_DIR 2>/dev/null)" ]; then
              echo "==> Creating backup at ${BACKUP_DIR}..."
              mkdir -p "${BACKUP_DIR}"
              cp -a $APP_DIR/. "${BACKUP_DIR}/"
              echo "Backup created successfully"

              # Keep only last 5 backups
              cd /var/www/releases
              ls -t | grep "^backup_" | tail -n +6 | xargs -r rm -rf
              echo "Old backups cleaned up"
            else
              echo "No existing deployment to backup"
            fi

            # Prepare deployment directory
            mkdir -p $APP_DIR
          PREPARE_SCRIPT

      - name: Copy artifact to server
        run: |
          scp -i ~/.ssh/deploy_key deployment-${{ github.sha }}.tar.gz \
            deploy@${{ secrets.PRODUCTION_HOST }}:/tmp/deployment.tar.gz

      - name: Extract and activate deployment
        run: |
          ssh -i ~/.ssh/deploy_key deploy@${{ secrets.PRODUCTION_HOST }} << 'DEPLOY_SCRIPT'
          set -e

          APP_DIR=/var/www/storywriter-prod
          cd $APP_DIR

          echo "==> Extracting new deployment..."
          tar -xzf /tmp/deployment.tar.gz -C $APP_DIR
          rm /tmp/deployment.tar.gz

          echo "==> Configuring environment..."
          DB_PASSWORD=$(sudo grep "Password:" /root/.db_credentials | awk '{print $2}')

          cat > .env << 'ENVEOF'
          APP_NAME=StoryWriter
          APP_ENV=production
          APP_KEY=${{ secrets.APP_KEY }}
          APP_DEBUG=false
          APP_TIMEZONE=UTC
          APP_URL=https://${{ secrets.PRODUCTION_HOST }}

          APP_LOCALE=en
          APP_FALLBACK_LOCALE=en
          APP_FAKER_LOCALE=en_US

          APP_MAINTENANCE_DRIVER=file

          BCRYPT_ROUNDS=12

          LOG_CHANNEL=stack
          LOG_STACK=single
          LOG_DEPRECATIONS_CHANNEL=null
          LOG_LEVEL=error

          DB_CONNECTION=pgsql
          DB_HOST=localhost
          DB_PORT=5432
          DB_DATABASE=storywriter_prod
          DB_USERNAME=storywriter_app
          ENVEOF

          echo "DB_PASSWORD=${DB_PASSWORD}" >> .env

          cat >> .env << 'ENVEOF'

          SESSION_DRIVER=database
          SESSION_LIFETIME=120
          SESSION_ENCRYPT=false
          SESSION_PATH=/
          SESSION_DOMAIN=null

          BROADCAST_CONNECTION=log
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=database

          CACHE_STORE=database
          CACHE_PREFIX=

          MEMCACHED_HOST=127.0.0.1

          REDIS_CLIENT=phpredis
          REDIS_HOST=127.0.0.1
          REDIS_PASSWORD=null
          REDIS_PORT=6379

          MAIL_MAILER=log
          MAIL_FROM_ADDRESS="hello@example.com"
          MAIL_FROM_NAME="${APP_NAME}"

          VITE_APP_NAME="${APP_NAME}"
          ENVEOF

          echo "==> Running database migrations..."
          php artisan migrate --force

          echo "==> Clearing and rebuilding caches..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

          echo "==> Setting permissions..."
          chmod -R 775 storage bootstrap/cache 2>/dev/null || true

          echo "==> Reloading PHP-FPM..."
          sudo /bin/systemctl reload php8.4-fpm

          echo "==> Deployment completed successfully!"
          echo "Deployed commit: ${{ github.sha }}"
          DEPLOY_SCRIPT

      - name: Health check
        run: |
          echo "==> Running health check..."
          sleep 5

          # Try to reach the application via HTTPS
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.PRODUCTION_HOST }} || echo "000")

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "‚úì Health check passed (HTTP $HTTP_CODE)"
          else
            echo "‚úó Health check failed (HTTP $HTTP_CODE)"
            echo "::error::Application is not responding correctly. Deployment has failed."
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Deployment summary
        if: success()
        run: |
          echo "::notice::üöÄ Deployment to production successful!"
          echo "::notice::Commit: ${{ github.sha }}"
          echo "::notice::Branch: ${{ github.ref_name }}"
          echo "::notice::Deployed by: ${{ github.actor }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::‚ùå Deployment to production failed!"
          echo "::error::Check the logs above for details"
          echo "::error::To rollback, SSH to the server and restore from /var/www/releases/"
